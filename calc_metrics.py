import argparse

import pandas as pd

from sklearn.metrics import classification_report


def metrics(df):
    labels = df['question_class']
    choices = df['choice'].fillna(0)
    print(classification_report(labels, choices))


def inspect_errors(df):

    print(f"{df['success'].sum()}/{len(df)} calls returned a usable, parseable result.")

    pd.set_option('display.max_colwidth', None)
    print('The completions that failed to parse: ')
    for i, row in df[~df['success']].iterrows():
        print('==== PROMPT ====')
        print(row['prompt'])
        print('\n==== COMPLETION ====')
        print(row['full_completion'])
        print('\n#################################################\n')


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='')
    parser.add_argument('--results_file', type=str)
    _args = parser.parse_args()

    _df = pd.read_json(_args.results_file, orient='records', lines=True)

    metrics(_df)
    inspect_errors(_df)
